import * as Localization from 'expo-localization';

export type Language = 'zh' | 'en';

const normalizeLanguage = (locale: string | undefined): Language => {
  if (!locale) return 'zh';
  return locale.toLowerCase().startsWith('zh') ? 'zh' : 'en';
};

export const getLanguage = (): Language => {
  const locales = Localization.getLocales();
  return normalizeLanguage(locales[0]?.languageTag);
};

const translations: Record<Language, Record<string, string>> = {
  zh: {
    'common.cancel': '取消',
    'common.confirm': '确定',
    'common.delete': '删除',
    'common.save': '保存',
    'common.close': '关闭',
    'common.success': '成功',
    'common.error': '错误',
    'common.share': '分享',
    'common.preview': '预览',
    'common.done': '完成',
    'home.titleAll': '全部便签',
    'home.searchPlaceholder': '搜索便签...',
    'home.emptyTitle': '暂无便签',
    'home.emptyHint': '点击右上角 ✏️ 创建新便签',
    'home.addFolderTitle': '新建文件夹',
    'home.folderPlaceholder': '文件夹名称',
    'home.deleteFolderTitle': '删除文件夹',
    'home.deleteFolderMessage': '确定要删除这个文件夹吗？',
    'home.folderAll': '全部便签',
    'home.folderFavorites': '加星便签',
    'note.untitled': '无标题',
    'note.empty': '空白便签',
    'editor.titlePlaceholder': '标题',
    'editor.contentPlaceholder': '开始输入...',
    'editor.markdownPlaceholder': '使用 Markdown 语法...',
    'editor.previewLabel': '预览：',
    'editor.deleteTitle': '删除便签',
    'editor.deleteMessage': '确定要删除这条便签吗？',
    'editor.copySuccess': '文字已复制到剪贴板',
    'editor.exportImageError': '导出图片失败',
    'editor.exportPdfError': '导出 PDF 失败',
    'editor.imageActions': '图片操作',
    'editor.imageCrop': '裁剪图片',
    'editor.imageDelete': '删除图片',
    'editor.imageNote': '图片备注',
    'editor.imageNotePlaceholder': '添加图片说明...',
    'editor.imageSave': '保存到相册',
    'editor.imagePreview': '全屏查看',
    'editor.imageSaveSuccess': '已保存到相册',
    'editor.imageSaveError': '保存到相册失败',
    'editor.imagePermission': '需要相册权限才能保存',
    'editor.exportTitle': '请选择操作',
    'editor.exportCopy': '复制文字',
    'editor.exportWeibo': '分享至新浪长图微博',
    'editor.exportImage': '以图片形式分享',
    'editor.exportMail': '发送邮件',
    'editor.exportKnowledge': '导入到知识库',
    'editor.metaDate': '更新于 {time}',
    'editor.wordCount': '{count} 字',
    'toolbar.title': '标题',
    'toolbar.center': '居中',
    'toolbar.list': '列表',
    'toolbar.bold': '粗体',
    'toolbar.quote': '引用',
    'toolbar.todo': '待办',
    'format.plain': '无',
    'format.rich': '富文本模式',
    'format.markdown': 'Markdown 模式',
    'settings.title': '设置',
    'settings.sectionEditor': '编辑偏好',
    'settings.sectionShare': '分享设置',
    'settings.sectionAppearance': '外观与背景',
    'settings.sectionSort': '便签排序',
    'settings.sectionSecurity': '安全设置',
    'settings.sectionAbout': '关于',
    'settings.faceId': 'Face ID',
    'settings.faceIdDesc': '使用面容识别保护便签',
    'settings.shareFooter': '分享页脚',
    'settings.shareFooterPlaceholder': '输入页脚文案',
    'settings.defaultFormat': '默认排版模式',
    'settings.textSize': '文字大小',
    'settings.appearance': '外观与背景',
    'settings.sort': '便签排序方式',
    'settings.language': '语言',
    'settings.systemLanguage': '跟随系统',
    'settings.version': '应用版本',
    'settings.features': '功能特性',
    'settings.featureDesc': '拟物风格 · 富文本 · Markdown',
    'settings.footerHint': '支持 {time} 自动替换',
    'settings.appearanceWood': '木纹复古',
    'settings.appearanceLinen': '浅色简约',
    'settings.appearancePaper': '纸张拟物',
    'settings.textSmall': '小',
    'settings.textMedium': '中',
    'settings.textLarge': '大',
    'settings.sortUpdatedDesc': '按更新时间（新到旧）',
    'settings.sortUpdatedAsc': '按更新时间（旧到新）',
    'settings.sortCreatedDesc': '按创建时间（新到旧）',
    'settings.sortCreatedAsc': '按创建时间（旧到新）',
    'lock.title': '便签已锁定',
    'lock.subtitle': '请验证身份以继续',
    'lock.faceId': '使用 Face ID',
    'lock.unavailable': 'Face ID 未开启',
    'share.title': '图片预览',
    'share.save': '保存到相册',
    'share.share': '分享',
  },
  en: {
    'common.cancel': 'Cancel',
    'common.confirm': 'Confirm',
    'common.delete': 'Delete',
    'common.save': 'Save',
    'common.close': 'Close',
    'common.success': 'Success',
    'common.error': 'Error',
    'common.share': 'Share',
    'common.preview': 'Preview',
    'common.done': 'Done',
    'home.titleAll': 'All Notes',
    'home.searchPlaceholder': 'Search notes...',
    'home.emptyTitle': 'No notes yet',
    'home.emptyHint': 'Tap ✏️ to create a new note',
    'home.addFolderTitle': 'New Folder',
    'home.folderPlaceholder': 'Folder name',
    'home.deleteFolderTitle': 'Delete Folder',
    'home.deleteFolderMessage': 'Delete this folder?',
    'home.folderAll': 'All Notes',
    'home.folderFavorites': 'Starred Notes',
    'note.untitled': 'Untitled',
    'note.empty': 'Empty note',
    'editor.titlePlaceholder': 'Title',
    'editor.contentPlaceholder': 'Start typing...',
    'editor.markdownPlaceholder': 'Use Markdown syntax...',
    'editor.previewLabel': 'Preview:',
    'editor.deleteTitle': 'Delete Note',
    'editor.deleteMessage': 'Delete this note?',
    'editor.copySuccess': 'Copied to clipboard',
    'editor.exportImageError': 'Failed to export image',
    'editor.exportPdfError': 'Failed to export PDF',
    'editor.imageActions': 'Image Actions',
    'editor.imageCrop': 'Crop Image',
    'editor.imageDelete': 'Delete Image',
    'editor.imageNote': 'Image Caption',
    'editor.imageNotePlaceholder': 'Add a caption...',
    'editor.imageSave': 'Save to Photos',
    'editor.imagePreview': 'Full Screen',
    'editor.imageSaveSuccess': 'Saved to Photos',
    'editor.imageSaveError': 'Save failed',
    'editor.imagePermission': 'Photo permission required',
    'editor.exportTitle': 'Choose an action',
    'editor.exportCopy': 'Copy Text',
    'editor.exportWeibo': 'Share to Weibo',
    'editor.exportImage': 'Share as Image',
    'editor.exportMail': 'Send Email',
    'editor.exportKnowledge': 'Add to Knowledge Base',
    'editor.metaDate': 'Updated {time}',
    'editor.wordCount': '{count} words',
    'toolbar.title': 'Title',
    'toolbar.center': 'Center',
    'toolbar.list': 'List',
    'toolbar.bold': 'Bold',
    'toolbar.quote': 'Quote',
    'toolbar.todo': 'Todo',
    'format.plain': 'Plain',
    'format.rich': 'Rich Text',
    'format.markdown': 'Markdown',
    'settings.title': 'Settings',
    'settings.sectionEditor': 'Editor',
    'settings.sectionShare': 'Share',
    'settings.sectionAppearance': 'Appearance',
    'settings.sectionSort': 'Sorting',
    'settings.sectionSecurity': 'Security',
    'settings.sectionAbout': 'About',
    'settings.faceId': 'Face ID',
    'settings.faceIdDesc': 'Protect notes with Face ID',
    'settings.shareFooter': 'Share Footer',
    'settings.shareFooterPlaceholder': 'Footer text',
    'settings.defaultFormat': 'Default Format',
    'settings.textSize': 'Text Size',
    'settings.appearance': 'Appearance & Background',
    'settings.sort': 'Sort Notes By',
    'settings.language': 'Language',
    'settings.systemLanguage': 'System default',
    'settings.version': 'App version',
    'settings.features': 'Highlights',
    'settings.featureDesc': 'Skeuomorphic · Rich Text · Markdown',
    'settings.footerHint': 'Supports {time} placeholder',
    'settings.appearanceWood': 'Wood Desk',
    'settings.appearanceLinen': 'Minimal Light',
    'settings.appearancePaper': 'Paper Craft',
    'settings.textSmall': 'Small',
    'settings.textMedium': 'Medium',
    'settings.textLarge': 'Large',
    'settings.sortUpdatedDesc': 'Updated (new to old)',
    'settings.sortUpdatedAsc': 'Updated (old to new)',
    'settings.sortCreatedDesc': 'Created (new to old)',
    'settings.sortCreatedAsc': 'Created (old to new)',
    'lock.title': 'Notes Locked',
    'lock.subtitle': 'Authenticate to continue',
    'lock.faceId': 'Use Face ID',
    'lock.unavailable': 'Face ID is disabled',
    'share.title': 'Image Preview',
    'share.save': 'Save to Photos',
    'share.share': 'Share',
  },
};

export const t = (key: string, params?: Record<string, string | number>) => {
  const language = getLanguage();
  const template =
    translations[language][key] || translations.zh[key] || key;

  if (!params) return template;
  return Object.keys(params).reduce(
    (result, paramKey) =>
      result.replace(`{${paramKey}}`, String(params[paramKey])),
    template
  );
};

const resolveLocaleTag = () => (getLanguage() === 'zh' ? 'zh-CN' : 'en-US');

export const formatDateTime = (timestamp: number) => {
  return new Intl.DateTimeFormat(resolveLocaleTag(), {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(timestamp));
};

export const formatDate = (timestamp: number) => {
  return new Intl.DateTimeFormat(resolveLocaleTag(), {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
  }).format(new Date(timestamp));
};
